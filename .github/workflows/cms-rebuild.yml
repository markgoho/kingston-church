name: CMS Rebuild

on:
  repository_dispatch:
    types: [cms-update]

jobs:
  rebuild:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/${{ github.repository }}:master
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install firebase-admin
        run: npm install firebase-admin

      - name: Fetch content from Firestore
        run: node .github/scripts/fetch-firestore-content.mjs
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}

      - name: Build Hugo site
        run: cd hugo && hugo --minify

      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          channelId: live
          projectId: kingstonchurchofchrist-8a8f3
          target: site
